<!DOCTYPE html>
<html lang="es">
{% load static %}
<head>
    <meta charset="UTF-8">
    <title>EDUGES - Asignar Montos</title>
    <style>
        body { margin:0; font-family:Arial,sans-serif; background:url("{% static 'imagenes/fondo_de_asignar_monto.png' %}") no-repeat center center fixed; background-size:cover; color:#fff; }
        header { background:#072f6b; color:white; padding:20px 30px; display:flex; align-items:center; }
        .logo-container { display:flex; align-items:center; gap:25px; }
        .logo-container img { height:80px; }
        .logo-text { font-size:40px; font-weight:bold; }
        .container { display:flex; min-height:100vh; }
        .sidebar { width:280px; background:#0b3d91; padding:20px 30px; display:flex; flex-direction:column; justify-content:space-between; box-sizing:border-box; min-height:100vh; }
        .menu { list-style:none; padding:0; margin:0; }
        .menu li { margin:15px 0; }
        .menu a { display:block; text-decoration:none; color:white; font-weight:bold; font-size:20px; padding:10px 15px; border-radius:5px; }
        .menu a:hover { background:#072f6b; }
        .submenu ul { list-style:none; padding-left:20px; margin-top:5px; max-height:0; overflow:hidden; transition:max-height 0.3s ease; }
        .submenu ul.open { max-height:500px; }
        .submenu a { position:relative; cursor:pointer; }
        .submenu > a::after { content:"‚ñº"; position:absolute; right:15px; font-size:12px; transition:transform 0.3s; }
        .submenu ul li a { font-weight:normal; font-size:18px; padding-left:25px; }
        .submenu ul li a:hover { background:#09417e; }
        .user-info { color:white; font-weight:bold; font-size:18px; }
        .user-info span { margin-right:10px; font-size:20px; }
        .user-email { font-size:14px; color:#e0e0e0; margin-left:0; }
        .logout form { margin-top:10px; }
        .logout button { width:100%; padding:10px; background:#c0392b; color:white; border:none; border-radius:5px; cursor:pointer; font-size:16px; }
        .logout button:hover { background:#e74c3c; }
        .content { flex:1; display:flex; justify-content:center; align-items:flex-start; padding:40px 20px; min-height:100vh; }
        .form-container { width:650px; background:#fff; padding:30px; border-radius:20px; box-shadow:0 8px 25px rgba(0,0,0,0.5); color:#072f6b; }
        .form-container h2 { text-align:center; font-size:2rem; margin-top:0; margin-bottom:25px; color:#0b3d91; }
        .form-group { position:relative; margin-bottom:20px; }
        .form-group input, .form-group select { width:100%; padding:12px; border-radius:8px; border:1px solid #ccc; background:#fff; font-size:16px; }
        .form-group input:focus, .form-group select:focus { outline:none; border-color:#0b3d91; box-shadow:0 0 5px #0b3d91; }
        .form-group label { position:absolute; top:50%; left:15px; transform:translateY(-50%); background:#fff; padding:0 5px; color:#777; font-size:14px; transition:0.3s; pointer-events:none; }
        .form-group input:focus + label,
        .form-group input:not(:placeholder-shown) + label,
        .form-group select:focus + label,
        .form-group select:not([value=""]) + label,
        .form-group select:valid + label { top:-10px; left:10px; font-size:12px; color:#0b3d91; }

        /* Estilos de Botones */
        button, .action-row a { 
            padding:14px; 
            border:none; 
            border-radius:10px; 
            font-weight:bold; 
            font-size:18px; 
            cursor:pointer; 
            transition:0.3s; 
            margin-top:10px;
        }

        .action-row { display: flex; gap: 10px; margin-top: 20px; }
        .action-row button, .action-row a { 
            width: 50%; 
            margin-top: 0; 
            text-decoration: none; 
            text-align: center; 
            display: block;
        }
        
        .btn-guardar { background:#2ecc71; color:white; }
        .btn-guardar:hover { background:#27ae60; }
        
        .btn-cancelar { background:#c0392b; color:white; } 
        .btn-cancelar:hover { background:#e74c3c; }

        .select-year-group button { background: #0b3d91; color: white; }
        .select-year-group button:hover { background: #06427a; }


        .messages { margin-bottom:15px; padding:10px; border-radius:8px; background:#2ecc71; color:white; font-weight:bold; text-align:center; }
        .messages.error { background:#e74c3c; }
        .month-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
        .select-year-group { display:flex; gap:10px; align-items:center; }
        .select-year-group .form-group { flex-grow:1; margin-bottom:0; }
        .select-year-group button { width:150px; margin-top:0; padding:12px; }
        .form-group .monto-input { text-align: right; }
        
        /* ---------------------------------------------------- */
        /* ESTILOS VISUALES PARA LA SECCI√ìN DE MONTOS */
        /* ---------------------------------------------------- */
        
        /* Contenedor de Febrero (Destacado) */
        .february-section { 
            margin-bottom: 20px; 
            padding: 15px; 
            border: 2px solid #0b3d91; /* Borde azul fuerte */
            border-radius: 10px; 
            background-color: #f0f8ff; /* Fondo celeste muy claro */
            color: #072f6b; 
        }
        /* Etiquetas de los campos dentro de la grilla (Marzo a Diciembre) */
        .month-grid .form-group {
             padding: 10px;
             border: 1px solid #ddd;
             border-radius: 8px;
             background-color: #f9f9f9; /* Fondo gris muy claro para contraste */
        }
    </style>
</head>
<body>
<header>
    <div class="logo-container">
        <img src="{% static 'imagenes/eduges1.png' %}" alt="EduGes">
        <span class="logo-text">EduGes</span>
    </div>
</header>

<div class="container">
    <aside class="sidebar">
        <div>
            <ul class="menu">
                <li><a href="{% url 'home' %}">üèõÔ∏è Inicio</a></li>
                <li class="submenu">
                    <a>Alumnos</a>
                    <ul>
                        <li><a href="{% url 'alta_alumnos' %}">‚úÖ Alta alumnos</a></li>
                        <li><a href="{% url 'modificar_alumnos' %}">‚öôÔ∏è Modificar alumnos</a></li>
                        <li><a href="{% url 'baja_alumnos' %}">‚ùå Baja alumnos</a></li>
                    </ul>
                </li>
                <li class="submenu">
                    <a>Tutores</a>
                    <ul>
                        <li><a href="{% url 'alta_tutores' %}">‚úÖ Alta tutores</a></li>
                        <li><a href="{% url 'modificar_tutores' %}">‚öôÔ∏è Modificar tutores</a></li>
                        <li><a href="{% url 'baja_tutores' %}">‚ùå Baja tutores</a></li>
                    </ul>
                </li>
                <li class="submenu">
                    <a>Usuarios</a>
                    <ul>
                        <li><a href="{% url 'alta_usuarios' %}">‚úÖ Alta usuario</a></li>
                        <li><a href="{% url 'modificar_usuarios' %}">‚öôÔ∏è Modificar usuario</a></li>
                        <li><a href="{% url 'baja_usuarios' %}">‚ùå Baja usuario</a></li>
                    </ul>
                </li>
                <li class="submenu">
                    <a class="active">Pagos</a>
                    <ul class="open">
                        <li><a href="{% url 'asignar_monto' %}"> Asignar monto</a></li>
                        <li><a href="{% url 'pagos_alumnos' %}"> Pagos alumnos</a></li>
                    </ul>
                </li>
                <li class="submenu">
                    <a>Reportes</a>
                    <ul>
                        <li><a href="{% url 'tutores_vencida' %}">Tutores de cuota vencida</a></li>
                        <li><a href="{% url 'cantidad_vencidas' %}">Cantidad de cuotas vencidas</a></li>
                        <li><a href="{% url 'alumnos_dia' %}">Alumnos con cuotas al d√≠a</a></li>
                    </ul>
                </li>
            </ul>
        </div>
        <div class="user-info">
            {% if request.user.is_authenticated %}
            <div><span>üë§</span>{{ request.user.username }}</div>
            <div class="user-email">{{ request.user.email }}</div>
            <div class="logout">
                <form action="{% url 'logout' %}" method="post">
                    {% csrf_token %}
                    <button type="submit">Cerrar sesi√≥n</button>
                </form>
            </div>
            {% endif %}
        </div>
    </aside>

    <main class="content">
        <div class="form-container">

            {% if messages %}
                {% for message in messages %}
                    <div class="messages {% if message.tags %}{{ message.tags }}{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            <h2>Asignar Montos de Cuotas Mensuales</h2>

            <form id="asignarMontoForm" method="POST" action="{% url 'asignar_monto' %}">
                {% csrf_token %}
                <div class="select-year-group">
                    <div class="form-group">
                        <select name="selected_year" id="year_select" required>
                            <option value="" disabled {% if not selected_year %}selected{% endif %}> (Seleccionar A√±o) </option>
                            {% for year in years %}
                                <option value="{{ year }}" {% if selected_year|stringformat:'s' == year|stringformat:'s' %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                        <label for="year_select">A√±o a asignar</label>
                    </div>
                    <button type="submit" name="action_type" value="select_year" id="btn-seleccionar-year">Seleccionar</button>
                </div>
            </form>

            {% if selected_year %}
            <form id="monthForm" method="POST" action="{% url 'asignar_monto' %}" style="margin-top:25px;">
                {% csrf_token %}
                <input type="hidden" name="selected_year" value="{{ selected_year }}">
                
                <h3>Montos por Mes (A√±o: {{ selected_year }})</h3>
                
                {% if february_data %}
                <div class="february-section">
                    <div class="form-group">
                        <input 
                            type="text" 
                            name="monto_{{ february_data.num }}" 
                            class="monto-input" 
                            id="monto_{{ february_data.num }}" 
                            placeholder=" " 
                            value="{{ february_data.value|default:'' }}" 
                            
                            pattern="^\d+(\.\d{1,2})?$" 
                            title="Ingrese solo n√∫meros (Ej: 60000 o 60000.50)"
                            
                            required 
                        >
                        <label for="monto_{{ february_data.num }}">{{ february_data.label }}</label>
                    </div>
                </div>
                {% endif %}
                
                <div class="month-grid">
                    {% for month in months_data %}
                        <div class="form-group">
                            <input 
                                type="text" 
                                name="monto_{{ month.num }}" 
                                class="monto-input" 
                                id="monto_{{ month.num }}" 
                                placeholder=" " 
                                value="{{ month.value|default:'' }}" 
                                
                                pattern="^\d+(\.\d{1,2})?$" 
                                title="Ingrese solo n√∫meros (Ej: 60000 o 60000.50)"
                            >
                            <label for="monto_{{ month.num }}">{{ month.label }}</label>
                        </div>
                    {% endfor %}
                </div>
                
                <div class="action-row">
                    <button type="submit" name="action_type" value="save_montos" class="btn-guardar">Guardar</button>
                    <a href="{% url 'asignar_monto' %}" class="btn-cancelar">Cancelar</a>
                </div>

            </form>
            {% endif %}

        </div>
    </main>
</div>

<script>
    const monthForm = document.getElementById("monthForm");
    const montoInputs = document.querySelectorAll('.monto-input');
    
    document.querySelectorAll(".submenu > a").forEach(menu => {
        menu.addEventListener("click", e => {
            e.preventDefault();
            const sublist = menu.nextElementSibling;
            document.querySelectorAll(".submenu ul").forEach(ul => {
                if (ul !== sublist) ul.classList.remove("open");
            });
            sublist.classList.toggle("open");
        });
    });

    if(monthForm){

        montoInputs.forEach(input => {
            input.addEventListener('keydown', function(e) {
                if ([8, 9, 27, 13, 46].includes(e.keyCode) ||
                    (e.keyCode >= 35 && e.keyCode <= 40) ||
                    (e.metaKey || e.ctrlKey)) {
                    return;
                }
                if (!((e.keyCode >= 48 && e.keyCode <= 57) || (e.keyCode >= 96 && e.keyCode <= 105) || e.key === '.')) {
                    e.preventDefault();
                }
            });

            input.addEventListener('input', function() {
                this.value = this.value.replace(/,/g, '.');
                const parts = this.value.split('.');
                if (parts.length > 2) {
                    this.value = parts.shift() + '.' + parts.join('');
                }
                if (this.value.match(/[^\d.]/g)) {
                    this.value = this.value.replace(/[^\d.]/g, '');
                }
            });
        });


        monthForm.addEventListener('submit', function(e) {
            let allMontosValid = true;

            montoInputs.forEach(input => {
                input.style.borderColor = '';
                
                if (!input.checkValidity()) {
                    allMontosValid = false;
                    input.style.borderColor = '#e74c3c';
                }
            });

            if (!allMontosValid) {
                e.preventDefault();
                alert('‚ö†Ô∏è Por favor, revise los campos. Solo se permiten n√∫meros y el formato (Ej: 60000 o 60000.50). El mes de Febrero es obligatorio.');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const selectYear = document.getElementById('year_select');
        if (selectYear && selectYear.value !== "") {
            selectYear.dispatchEvent(new Event('change'));
        }
        montoInputs.forEach(input => {
            if (input.value.trim() !== "") {
                input.dispatchEvent(new Event('change'));
            }
        });
    });
</script>

</body>
</html>
